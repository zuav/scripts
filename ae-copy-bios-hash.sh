#!/bin/sh

SRC_FILE=$1
DST_FILE=$2


MAIN_FV_GUID=ED43534D-1C23-4adc-AAFD-76D7A939048C
KERNEL_OS_GUID=E39A1408-F073-4384-A0DA-8D24F1F96925
DOM0_KERNEL_OS_GUID=87AC174A-C2C3-4D4A-8F4C-1110194DB8F5
IMAGE_OS_GUID=A4C7517E-37CF-495D-911D-58F9BD61007A
BIOS_PASS_GUID=9FF5F12F-CE84-4271-9CC3-548205D49B01
FAILSAFE_PASS_GUID=E5619A8E-309B-40D4-BD29-795D722268BE
UPDATE_GUID=96839B66-BCBF-42E0-B64F-67D31B95CD2C
HASH_STR=B737CBDBE6268024CB40C0F2189ED73EDE615430D0000163A8D7814804234051 


SIGNFV=./tmp/staging/x86_64-linux/usr/bin/signfv

KERNEL_OS_HASH=`$SIGNFV -r -o $SRC_FILE | awk -v guid_val=$KERNEL_OS_GUID -f ./ae-filter-guid.awk`
DOM0_KERNEL_OS_HASH=`$SIGNFV -r -o $SRC_FILE | awk -v guid_val=$DOM0_KERNEL_OS_GUID -f ./ae-filter-guid.awk`
IMAGE_OS_HASH=`$SIGNFV -r -o $SRC_FILE | awk -v guid_val=$IMAGE_OS_GUID -f ./ae-filter-guid.awk`

echo "KERNEL_OS_HASH      =" $KERNEL_OS_HASH
echo "DOM0_KERNEL_OS_HASH =" $DOM0_KERNEL_OS_HASH
echo "IMAGE_OS_HASH       =" $IMAGE_OS_HASH

echo -n "rootpassword"     > /tmp/bios.pass
echo -n "failsafepassword" > /tmp/failsafe.pass

$SIGNFV -c -o $DST_FILE
$SIGNFV    -o $DST_FILE -g $MAIN_FV_GUID        -t 4
$SIGNFV    -o $DST_FILE -g $BIOS_PASS_GUID      -t 4 -i /tmp/bios.pass
$SIGNFV    -o $DST_FILE -g $KERNEL_OS_GUID      -t 4 -v $KERNEL_OS_HASH
$SIGNFV    -o $DST_FILE -g $DOM0_KERNEL_OS_GUID -t 4 -v $DOM0_KERNEL_OS_HASH
$SIGNFV    -o $DST_FILE -g $IMAGE_OS_GUID       -t 4 -v $IMAGE_OS_HASH
$SIGNFV    -o $DST_FILE -g $FAILSAFE_PASS_GUID  -t 4 -i /tmp/failsafe.pass
$SIGNFV    -o $DST_FILE -g $UPDATE_GUID         -t 4 -v $HASH_STR

